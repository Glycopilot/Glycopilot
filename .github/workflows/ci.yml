name: Deploy to AWS EC2

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install gitleaks
      run: |
        GITLEAKS_VERSION="8.29.0"
        curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz -o gitleaks.tar.gz
        tar -xzf gitleaks.tar.gz gitleaks
        sudo mv gitleaks /usr/local/bin/gitleaks
        rm gitleaks.tar.gz
    
    - name: Run gitleaks scan
      run: gitleaks detect --source . --redact --report-path gitleaks-report.json

  test-backend:
    needs: secret-scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-django
    
    - name: Run tests with coverage
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        SECRET_KEY_ADMIN: ${{ secrets.SECRET_KEY_ADMIN }}
        SMTP_HOST: ${{ secrets.SMTP_HOST }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        SMTP_USE_TLS: ${{ secrets.SMTP_USE_TLS }}
        TESTING: true
      run: |
        cd backend
        pytest --cov=. --cov-report=xml:coverage.xml --cov-report=html
    
    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-backend
        path: backend/coverage.xml
        retention-days: 1
        if-no-files-found: error
    
    - name: Lint with flake8
      run: |
        cd backend
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  sonarqube:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    continue-on-error: true  # TODO: Retirer une fois que le coverage sera suffisant
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download Backend Coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage-backend
        path: backend/
    
    - name: Verify Backend Coverage
      run: |
        if [ -f backend/coverage.xml ]; then
          echo "Backend coverage file found"
          ls -lh backend/coverage.xml
        else
          echo "Backend coverage file not found"
        fi
    
    - name: Download Frontend Coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage-frontend
        path: frontend/coverage/
      continue-on-error: true #a retirer plus tard si on configure les tests frontend
    
    - name: Verify Frontend Coverage
      run: |
        if [ -f frontend/coverage/lcov.info ]; then
          echo "Frontend coverage file found"
          ls -lh frontend/coverage/lcov.info
        else
          echo "Frontend coverage file not found"
        fi
      continue-on-error: true #a retirer plus tard si on configure les tests frontend
    
    - name: Cache SonarCloud packages
      uses: actions/cache@v4
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar-${{ hashFiles('**/sonar-project.properties') }}
        restore-keys: ${{ runner.os }}-sonar-
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarqube-scan-action@v6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: https://sonarcloud.io
    
    - name: Check Quality Gate Status
      run: |
        echo "::warning title=SonarQube Quality Gate::Le Quality Gate peut échouer en raison d'une couverture de code insuffisante. Ceci est temporaire pendant le développement."
        echo "SonarCloud analysis completed"
        echo "ATTENTION: continue-on-error est activé temporairement"
        echo "Le Quality Gate devrait passer une fois le code et les tests complétés"

  test-frontend:
    needs: secret-scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        cd frontend
        npm install
    
    - name: Run tests with coverage
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false || echo "No tests configured"
    
    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-frontend
        path: frontend/coverage/
        retention-days: 1
        if-no-files-found: ignore
      continue-on-error: true #a retirer plus tard si on configure les tests frontend

  deploy:
    needs: [test-backend, test-frontend, sonarqube]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' 
    steps:
    - uses: actions/checkout@v4
    
    - name: Copy files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "."
        target: "/var/www/glycopilot_app"
        rm: false
    
    - name: Deploy to AWS EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /var/www/glycopilot_app
          
          cat > .env << EOF
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          SECRET_KEY_ADMIN=${{ secrets.SECRET_KEY_ADMIN }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          DB_ENGINE=postgresql
          DB_NAME=django_db
          DB_USER=django_user
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=localhost
          DB_PORT=5432
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          SMTP_USE_TLS=${{ secrets.SMTP_USE_TLS }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME }}
          AWS_S3_REGION_NAME=eu-west-3
          EOF
          
          chmod +x deploy.sh
          ./deploy.sh

  notify:
    needs: [secret-scan, test-backend, test-frontend, sonarqube, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Pipeline Summary
      run: |
        echo "======================================"
        echo "PIPELINE SUMMARY"
        echo "======================================"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Triggered by: ${{ github.actor }}"
        echo ""
        echo "======================================"
        echo "Job Status:"
        echo "======================================"
        echo "Secret Scan: ${{ needs.secret-scan.result }}"
        echo "Backend Tests: ${{ needs.test-backend.result }}"
        echo "Frontend Tests: ${{ needs.test-frontend.result }}"
        echo "SonarQube: ${{ needs.sonarqube.result }}"
        echo "Deploy: ${{ needs.deploy.result }}"
        echo "======================================"
        
        # Déterminer le statut global
        if [ "${{ needs.secret-scan.result }}" != "success" ] || \
           [ "${{ needs.test-backend.result }}" != "success" ] || \
           [ "${{ needs.test-frontend.result }}" != "success" ] || \
           [ "${{ needs.sonarqube.result }}" != "success" ]; then
          echo "Pipeline FAILED - Quality checks did not pass"
          exit 1
        elif [ "${{ needs.deploy.result }}" == "failure" ]; then
          echo "Tests passed but deployment FAILED"
          exit 1
        elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
          echo "All quality checks PASSED (deployment skipped)"
        else
          echo "Pipeline SUCCESSFUL - All checks passed and deployed"
        fi
