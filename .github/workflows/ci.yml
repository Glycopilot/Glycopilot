name: Deploy to AWS EC2

on:
  push:
    branches: [ main, chore/setup-deployement-aws ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Install gitleaks
      run: |
        GITLEAKS_VERSION="8.29.0"
        curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz -o gitleaks.tar.gz
        tar -xzf gitleaks.tar.gz gitleaks
        sudo mv gitleaks /usr/local/bin/gitleaks
        rm gitleaks.tar.gz
    
    - name: Run gitleaks scan
      run: gitleaks detect --source . --redact --report-path gitleaks-report.json

  test-backend:
    needs: secret-scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run tests
      env:
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        SECRET_KEY_ADMIN: ${{ secrets.SECRET_KEY_ADMIN }}
        SMTP_HOST: ${{ secrets.SMTP_HOST }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        SMTP_USE_TLS: ${{ secrets.SMTP_USE_TLS }}
        TESTING: true
      run: |
        cd backend
        python manage.py test
    
    - name: Lint with flake8
      run: |
        cd backend
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true

  sonarqube:
    needs: [test-backend, test-frontend]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Nécessaire pour l'analyse complète de l'historique
    
    - name: Download Backend Coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage-backend
        path: backend/
      continue-on-error: true
    
    - name: Download Frontend Coverage
      uses: actions/download-artifact@v4
      with:
        name: coverage-frontend
        path: frontend/
      continue-on-error: true
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Nécessaire pour PR decoration
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      continue-on-error: true  # Temporaire: SonarCloud nécessite un premier scan de main pour initialiser le projet

  test-frontend:
    needs: secret-scan
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        cd frontend
        npm install

  deploy:
    needs: [test-backend, test-frontend, sonarqube]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/chore/setup-deployement-aws'
    steps:
    - uses: actions/checkout@v3
    
    - name: Copy files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "."
        target: "/var/www/glycopilot_app"
        rm: false
    
    - name: Deploy to AWS EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /var/www/glycopilot_app
          
          cat > .env << EOF
          DEBUG=False
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          SECRET_KEY_ADMIN=${{ secrets.SECRET_KEY_ADMIN }}
          ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
          DB_ENGINE=postgresql
          DB_NAME=django_db
          DB_USER=django_user
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_HOST=localhost
          DB_PORT=5432
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          SMTP_USE_TLS=${{ secrets.SMTP_USE_TLS }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_STORAGE_BUCKET_NAME=${{ secrets.AWS_STORAGE_BUCKET_NAME }}
          AWS_S3_REGION_NAME=eu-west-3
          EOF
          
          chmod +x deploy.sh
          ./deploy.sh

  notify:
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Send notification
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "Deployment successful"
        else
          echo "Deployment failed"
        fi
