#!/bin/sh
set -e

npm run check-branch-name

# Récupérer les fichiers Python modifiés
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)

if [ -z "$PYTHON_FILES" ]; then
    echo "Aucun fichier Python a verifier"
    exit 0
fi

cd backend

# Vérifier que le venv existe
if [ ! -f "venv/bin/python" ] && [ ! -f "venv/Scripts/python.exe" ]; then
    echo "ERREUR: venv non trouve dans backend/"
    echo "Creez un venv avec: cd backend && python -m venv venv"
    echo "Puis installez les deps: source venv/bin/activate && pip install -r requirements.txt"
    exit 1
fi

# Utiliser le venv
if [ -f "venv/bin/python" ]; then
    PYTHON_CMD="venv/bin/python"
else
    PYTHON_CMD="venv/Scripts/python.exe"
fi

echo "Verification et correction automatique du code Python..."

# Retourner au dossier racine pour les chemins git
cd ..

# Formater automatiquement avec isort
echo "Organisation des imports (isort)..."
for file in $PYTHON_FILES; do
    if [ -f "$file" ]; then
        $PYTHON_CMD -m isort "$file" 2>/dev/null || true
    fi
done

# Formater automatiquement avec black
echo "Formatage du code (black)..."
for file in $PYTHON_FILES; do
    if [ -f "$file" ]; then
        $PYTHON_CMD -m black "$file" 2>/dev/null || true
    fi
done

# Re-stage les fichiers modifiés par les formatters
for file in $PYTHON_FILES; do
    if [ -f "$file" ]; then
        git add "$file"
    fi
done

# Vérifier flake8 uniquement sur les fichiers modifiés
echo "Verification de la qualite du code (flake8)..."
cd backend
FLAKE8_ERRORS=""
for file in $PYTHON_FILES; do
    # Enlever le préfixe backend/ si présent
    relative_file="${file#backend/}"
    if [ -f "$relative_file" ]; then
        if ! $PYTHON_CMD -m flake8 "$relative_file" 2>/dev/null; then
            FLAKE8_ERRORS="1"
        fi
    fi
done
cd ..

if [ -n "$FLAKE8_ERRORS" ]; then
    echo ""
    echo "======================================================================"
    echo "Erreurs flake8 detectees (imports inutilises, variables, etc.)"
    echo "======================================================================"
    echo ""
    echo "Pour corriger automatiquement certaines erreurs :"
    echo "   ./scripts/fix_backend.sh"
    echo ""
    echo "Pour bypasser cette verification (non recommande) :"
    echo "   git commit --no-verify"
    echo ""
    echo "======================================================================"
    exit 1
fi

echo "Code Python verifie et formate avec succes !"
