#!/bin/sh
set -e

npm run check-branch-name

# RÃ©cupÃ©rer les fichiers Python modifiÃ©s
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.py$' || true)

if [ -z "$PYTHON_FILES" ]; then
    echo "âœ… Aucun fichier Python Ã  vÃ©rifier"
    exit 0
fi

cd backend

# Utiliser le venv si disponible, sinon python3 global
if [ -f "venv/bin/python" ]; then
    PYTHON_CMD="venv/bin/python"
elif [ -f "venv/Scripts/python.exe" ]; then
    PYTHON_CMD="venv/Scripts/python.exe"
else
    PYTHON_CMD="python3"
fi

echo "ğŸ” VÃ©rification et correction automatique du code Python..."

# Retourner au dossier racine pour les chemins git
cd ..

# Formater automatiquement avec isort
echo "ğŸ“¦ Organisation des imports (isort)..."
for file in $PYTHON_FILES; do
    if [ -f "$file" ]; then
        $PYTHON_CMD -m isort "$file" 2>/dev/null || true
    fi
done

# Formater automatiquement avec black
echo "ğŸ¨ Formatage du code (black)..."
for file in $PYTHON_FILES; do
    if [ -f "$file" ]; then
        $PYTHON_CMD -m black "$file" 2>/dev/null || true
    fi
done

# Re-stage les fichiers modifiÃ©s par les formatters
for file in $PYTHON_FILES; do
    if [ -f "$file" ]; then
        git add "$file"
    fi
done

# VÃ©rifier flake8 uniquement sur les fichiers modifiÃ©s
echo "ğŸ”§ VÃ©rification de la qualitÃ© du code (flake8)..."
FLAKE8_ERRORS=""
for file in $PYTHON_FILES; do
    if [ -f "$file" ]; then
        if ! $PYTHON_CMD -m flake8 "$file" 2>/dev/null; then
            FLAKE8_ERRORS="1"
        fi
    fi
done

if [ -n "$FLAKE8_ERRORS" ]; then
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âš ï¸  Erreurs flake8 dÃ©tectÃ©es (imports inutilisÃ©s, variables, etc.)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ’¡ Pour corriger automatiquement certaines erreurs :"
    echo "   ./scripts/fix_backend.sh"
    echo ""
    echo "ğŸ’¡ Pour bypasser cette vÃ©rification (non recommandÃ©) :"
    echo "   git commit --no-verify"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    exit 1
fi

echo "âœ… Code Python vÃ©rifiÃ© et formatÃ© avec succÃ¨s !"
